<!DOCTYPE html>
<html lang="en" data-theme="midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Analytics - QueueFlow</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="page-content">
    <!-- Premium Internal Navbar -->
    {% set user_name = session.superadmin_username %}
    {% set user_type = 'superadmin' %}
    {% set breadcrumb = ['Super Admin', 'Analytics'] %}
    {% include 'includes/internal_navbar.html' %}

    <div class="container-fluid px-4 py-4">
        <!-- System Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card text-center" style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); color: white; border: none;">
                    <div class="card-body py-3">
                        <h2 class="display-4 fw-bold mb-1" id="stat-centers">-</h2>
                        <p class="mb-0 fw-semibold small">Service Centers</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-primary);">
                    <div class="card-body py-3">
                        <h2 class="display-4 fw-bold mb-1" style="color: var(--color-primary);" id="stat-users">-</h2>
                        <p class="mb-0 fw-semibold small">Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-success);">
                    <div class="card-body py-3">
                        <h2 class="display-4 fw-bold mb-1" style="color: var(--color-success);" id="stat-daily">-</h2>
                        <p class="mb-0 fw-semibold small">Today's Tokens</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-accent);">
                    <div class="card-body py-3">
                        <h2 class="display-4 fw-bold mb-1" style="color: var(--color-accent);" id="stat-total">-</h2>
                        <p class="mb-0 fw-semibold small">Total Tokens</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row g-4 mb-4">
            <!-- System-wide Trend -->
            <div class="col-12">
                <div class="card hover-lift">
                    <div class="card-header">
                        <h5 class="mb-0">üìà System-Wide Activity (Last 7 Days)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row g-4 mb-4">
            <!-- Booking Types -->
            <div class="col-md-6">
                <div class="card hover-lift">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Booking Type Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="bookingChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Status Breakdown -->
            <div class="col-md-6">
                <div class="card hover-lift">
                    <div class="card-header">
                        <h5 class="mb-0">‚úÖ Token Status Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performing Centers -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card hover-lift">
                    <div class="card-header">
                        <h5 class="mb-0">üèÜ Top Performing Service Centers</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="topCentersChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    <script>
        // Get CSS variables
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();
        const successColor = getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim();
        const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim();
        const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim();

        Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();

        let trendChart, bookingChart, statusChart, topCentersChart;

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/superadmin/analytics');
                const data = await response.json();

                // Update stats
                document.getElementById('stat-centers').textContent = data.total_centers;
                document.getElementById('stat-users').textContent = data.total_users;
                document.getElementById('stat-daily').textContent = data.daily_tokens;
                document.getElementById('stat-total').textContent = data.total_tokens;

                // Trend Chart
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                if (trendChart) trendChart.destroy();
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: data.trend.map(d => d.date),
                        datasets: [{
                            label: 'System-Wide Tokens',
                            data: data.trend.map(d => d.count),
                            borderColor: primaryColor,
                            backgroundColor: primaryColor + '20',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: primaryColor,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });

                // Booking Chart
                const bookingCtx = document.getElementById('bookingChart').getContext('2d');
                if (bookingChart) bookingChart.destroy();
                bookingChart = new Chart(bookingCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Online Booking', 'Walk-In'],
                        datasets: [{
                            data: [data.booking_types.online, data.booking_types.walkin],
                            backgroundColor: [primaryColor, accentColor],
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 13, weight: '600' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return ` ${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1200
                        }
                    }
                });

                // Status Chart
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(statusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Completed', 'No Show', 'Expired'],
                        datasets: [{
                            label: 'Tokens',
                            data: [data.status.completed, data.status.no_show, data.status.expired],
                            backgroundColor: [successColor, dangerColor, warningColor],
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutBounce'
                        }
                    }
                });

                // Top Centers Chart
                const topCtx = document.getElementById('topCentersChart').getContext('2d');
                if (topCentersChart) topCentersChart.destroy();
                topCentersChart = new Chart(topCtx, {
                    type: 'bar',
                    data: {
                        labels: data.top_centers.map(c => c.name),
                        datasets: [{
                            label: 'Total Tokens',
                            data: data.top_centers.map(c => c.count),
                            backgroundColor: primaryColor,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            y: {
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        loadAnalytics();
    </script>
</body>
</html>
