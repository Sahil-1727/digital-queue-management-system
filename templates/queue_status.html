<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Status - QueueFlow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <meta http-equiv="refresh" content="30">
    <style>
        .notification-bell { position: fixed; top: 20px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.5); animation: shake 0.5s infinite; z-index: 9999; cursor: pointer; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body style="background: #F8FAFC;">
    <div class="notification-bell" id="notification-bell" onclick="document.getElementById('notification-alert').scrollIntoView({behavior: 'smooth'})">üîî</div>
    
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: #0F172A; border-bottom: 2px solid #2DD4BF;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('services') }}" style="color: white;">
                <span style="background: linear-gradient(135deg, #2DD4BF, #14B8A6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Queue</span>Flow
            </a>
            <a href="{{ url_for('services') }}" class="btn btn-outline-light btn-sm">‚Üê Back to Services</a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card slide-up" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h4 class="fw-bold">{{ token.service_center.name }}</h4>
                            <p class="text-muted">üìç {{ token.service_center.location }}</p>
                        </div>
                        
                        <div class="text-center p-5 mb-4" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 20px;">
                            <p class="text-muted text-sm mb-2">Your Token Number</p>
                            <h1 class="display-1 fw-bold gradient-text mb-0" style="animation: pulse 2s infinite;">{{ token.token_number }}</h1>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card text-center hover-lift" style="background: linear-gradient(135deg, #2DD4BF 0%, #14B8A6 100%); color: #0F172A; border: none; box-shadow: 0 8px 30px rgba(45, 212, 191, 0.3);">
                                    <div class="card-body py-4">
                                        <h2 class="display-5 fw-bold mb-2">{% if serving_token %}{{ serving_token.token_number }}{% else %}--{% endif %}</h2>
                                        <small class="fw-semibold">Currently Serving</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center hover-lift" style="background: #0F172A; color: white; border: 2px solid #2DD4BF;">
                                    <div class="card-body py-4">
                                        <h2 class="display-5 fw-bold mb-2" style="color: #2DD4BF;">{{ position }}</h2>
                                        <small class="fw-semibold">People Ahead</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center hover-lift" style="background: rgba(45, 212, 191, 0.1); color: #0F172A; border: 2px solid #2DD4BF;">
                                    <div class="card-body py-4">
                                        <h2 class="display-5 fw-bold mb-2">~{{ wait_time }}</h2>
                                        <small class="fw-semibold">Minutes Wait</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="queue-speed-indicator" class="alert alert-success mb-3" style="display: none; border-radius: 16px; border: none;">
                            <h6 class="fw-bold mb-2">‚ö° Queue Speed Status</h6>
                            <p class="mb-0" id="queue-speed-message"></p>
                        </div>

                        {% if token.status == 'Active' and position > 0 %}
                            <div class="alert alert-success mb-3" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                                <h5 class="text-center fw-bold text-success mb-2">üè† Suggested Leave Time</h5>
                                <h2 class="text-center display-4 fw-bold text-success mb-2">{{ leave_time.strftime('%I:%M %p') }}</h2>
                                <p class="text-center mb-1 text-success">Leave home around this time to avoid waiting</p>
                                {% if travel_time %}
                                <p class="text-center mb-0 small text-success">üöó Travel time: ~{{ travel_time }} mins</p>
                                {% endif %}
                            </div>
                            <div class="alert alert-info mb-3" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                                <h6 class="text-center fw-bold text-primary mb-2">üìÖ {{ reach_counter_time.strftime('%d %B %Y') }}</h6>
                                <h6 class="text-center fw-bold text-primary mb-2">‚è∞ Approx. Time to Reach Counter</h6>
                                <h3 class="text-center fw-bold text-primary mb-0">{{ reach_counter_time.strftime('%I:%M %p') }}</h3>
                            </div>
                            
                            <div id="notification-alert" class="alert alert-warning mb-3" style="display: none; border-radius: 16px; border: none;">
                                <h6 class="text-center fw-bold mb-2">üîî Notification</h6>
                                <p class="text-center mb-0 fw-semibold" id="notification-message"></p>
                            </div>
                        {% elif token.status == 'Serving' %}
                            <div class="alert alert-warning" style="border-radius: 16px; border: none;">
                                <h4 class="text-center fw-bold mb-2">üîî Your Turn!</h4>
                                <p class="text-center mb-0 fw-semibold">Please proceed to the service counter</p>
                            </div>
                        {% elif token.status == 'Completed' %}
                            <div class="alert alert-success" style="border-radius: 16px; border: none;">
                                <h4 class="text-center fw-bold mb-2">‚úÖ Service Completed</h4>
                                <p class="text-center mb-0 fw-semibold">Thank you for using QueueFlow!</p>
                            </div>
                        {% elif token.status == 'Expired' %}
                            <div class="alert alert-danger" style="border-radius: 16px; border: none;">
                                <h4 class="text-center fw-bold mb-2">‚ùå Token Expired</h4>
                                <p class="text-center mb-0 fw-semibold">This token is no longer valid</p>
                            </div>
                        {% endif %}

                        <div class="text-center mt-4">
                            <span class="badge {% if token.status == 'Active' %}bg-primary{% elif token.status == 'Serving' %}bg-warning{% elif token.status == 'Completed' %}bg-success{% else %}bg-secondary{% endif %}" style="padding: 10px 25px; font-size: 1.1rem;">
                                Status: {{ token.status }}
                            </span>
                        </div>

                        <p class="text-center text-muted mt-4 mb-0">
                            <small>‚è±Ô∏è Page auto-refreshes every 30 seconds</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" style="position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #2DD4BF, #14B8A6); border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; z-index: 9999; transition: all 0.3s ease;">üåô</button>
    <script>
        // Notification system
        let notificationShown = false;
        let leaveNotificationShown = false;
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        function showNotification(title, message) {
            // Show floating bell
            const bell = document.getElementById('notification-bell');
            if (bell) {
                bell.style.display = 'flex';
            }
            
            // Show in-app notification
            const alertDiv = document.getElementById('notification-alert');
            const messageDiv = document.getElementById('notification-message');
            if (alertDiv && messageDiv) {
                messageDiv.textContent = message;
                alertDiv.style.display = 'block';
                alertDiv.style.animation = 'pulse 1s infinite';
            }
            
            // Show browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/static/notification-icon.png',
                    badge: '/static/notification-icon.png'
                });
            }
        }
        
        function checkNotifications() {
            const now = new Date();
            const leaveTime = new Date('{{ leave_time.strftime("%Y-%m-%d %H:%M:%S") }}');
            const reachTime = new Date('{{ reach_counter_time.strftime("%Y-%m-%d %H:%M:%S") }}');
            
            const minutesToLeave = Math.floor((leaveTime - now) / 60000);
            const minutesToReach = Math.floor((reachTime - now) / 60000);
            
            // Check if queue is moving faster (position decreased)
            const currentPosition = {{ position }};
            const previousPosition = parseInt(sessionStorage.getItem('lastPosition') || currentPosition);
            
            if (currentPosition < previousPosition && currentPosition > 2) {
                const positionDrop = previousPosition - currentPosition;
                const speedIndicator = document.getElementById('queue-speed-indicator');
                const speedMessage = document.getElementById('queue-speed-message');
                
                if (speedIndicator && speedMessage) {
                    speedIndicator.style.display = 'block';
                    speedMessage.textContent = `‚ö° Queue moving ${positionDrop}x faster! ${positionDrop} people served quickly. You can leave early!`;
                }
                
                if (positionDrop >= 2) {
                    showNotification(
                        '‚ö° Queue Moving Fast!',
                        `Queue is moving faster! ${positionDrop} people served quickly. Consider leaving early!`
                    );
                }
            }
            sessionStorage.setItem('lastPosition', currentPosition);
            
            // Notification 5 minutes before leave time
            if (minutesToLeave <= 5 && minutesToLeave > 0 && !leaveNotificationShown) {
                showNotification(
                    'üè† Time to Leave!',
                    `Leave home in ${minutesToLeave} minutes to reach on time!`
                );
                leaveNotificationShown = true;
            }
            
            // Notification 10 minutes before counter time
            if (minutesToReach <= 10 && minutesToReach > 0 && !notificationShown) {
                showNotification(
                    '‚è∞ Please Reach Counter!',
                    'Please reach the counter within 10 minutes. Your turn is coming soon!'
                );
                notificationShown = true;
            }
            
            // Urgent notification when time is very close
            if (minutesToReach <= 2 && minutesToReach > 0) {
                showNotification(
                    'üî¥ URGENT: Your Turn Soon!',
                    'Please be at the counter NOW! Your turn is in 2 minutes!'
                );
            }
        }
        
        // Check immediately and every 30 seconds
        {% if token.status == 'Active' and position > 0 %}
        checkNotifications();
        setInterval(checkNotifications, 30000);
        {% endif %}
    </script>
</body>
</html>
