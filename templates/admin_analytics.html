<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  (function() {
    try {
      var t = localStorage.getItem('queueflow-theme');
      var p = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (t === 'dark' || (!t && p)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    } catch(e) {}
  })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - {{ center.name }}</title>
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/enhancements.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/ux-refinements.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/apple-refinement.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/elite-polish.css') }}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    .card-body canvas {
      display: block !important;
      box-sizing: border-box !important;
    }
  </style>
</head>
<body class="page-content">
  {% set user_name = center.name %}
  {% set user_type = 'admin' %}
  {% set breadcrumb = ['Dashboard', 'Analytics'] %}
  {% include 'includes/internal_navbar.html' %}

  <div class="container-fluid px-4 py-4">
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="card text-center" style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); color: white; border: none;">
          <div class="card-body py-3">
            <h2 class="display-4 fw-bold mb-1" id="stat-daily">-</h2>
            <p class="mb-0 fw-semibold small">Today's Customers</p>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-primary);">
          <div class="card-body py-3">
            <h2 class="display-4 fw-bold mb-1" style="color: var(--color-primary);" id="stat-total">-</h2>
            <p class="mb-0 fw-semibold small">Total Tokens</p>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-success);">
          <div class="card-body py-3">
            <h2 class="display-4 fw-bold mb-1" style="color: var(--color-success);" id="stat-online">-</h2>
            <p class="mb-0 fw-semibold small">Online Bookings</p>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center" style="background: var(--bg-card); border: 2px solid var(--color-accent);">
          <div class="card-body py-3">
            <h2 class="display-4 fw-bold mb-1" style="color: var(--color-accent);" id="stat-walkin">-</h2>
            <p class="mb-0 fw-semibold small">Walk-In Customers</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="card hover-lift">
          <div class="card-header">
            <h5 class="mb-0">üìÖ Last 7 Days Activity Trend</h5>
          </div>
          <div class="card-body">
            <div class="chart-wrapper">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-6">
        <div class="card hover-lift">
          <div class="card-header">
            <h5 class="mb-0">üìä Booking Type Distribution</h5>
          </div>
          <div class="card-body">
            <div class="chart-wrapper">
              <canvas id="bookingChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card hover-lift">
          <div class="card-header">
            <h5 class="mb-0">‚úÖ Token Status Breakdown</h5>
          </div>
          <div class="card-body">
            <div class="chart-wrapper">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-1">
      <div class="col-12">
        <div class="card hover-lift">
          <div class="card-header">
            <h5 class="mb-0">‚è∞ Peak Hours Analysis</h5>
          </div>
          <div class="card-body">
            <div class="chart-wrapper">
              <canvas id="peakHoursChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ux-refinements.js') }}"></script>
  <script src="{{ url_for('static', filename='js/elite-polish.js') }}"></script>
  <script>
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim();
    const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim();
    const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim();

    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();

    let trendChart, bookingChart, statusChart, peakHoursChart;

    async function loadAnalytics() {
      try {
        const response = await fetch('/api/admin/analytics');
        const data = await response.json();

        document.getElementById('stat-daily').textContent = data.daily_customers;
        document.getElementById('stat-total').textContent = data.total_tokens;
        document.getElementById('stat-online').textContent = data.booking_types.online;
        document.getElementById('stat-walkin').textContent = data.booking_types.walkin;

        const trendCtx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: data.trend.map(d => d.date),
            datasets: [{
              label: 'Tokens Booked',
              data: data.trend.map(d => d.count),
              borderColor: primaryColor,
              backgroundColor: primaryColor + '20',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: primaryColor,
              pointBorderColor: 'white',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                padding: 12,
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                cornerRadius: 8
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });

        const bookingCtx = document.getElementById('bookingChart').getContext('2d');
        if (bookingChart) bookingChart.destroy();
        bookingChart = new Chart(bookingCtx, {
          type: 'doughnut',
          data: {
            labels: ['Online Booking', 'Walk-In'],
            datasets: [{
              data: [data.booking_types.online, data.booking_types.walkin],
              backgroundColor: [primaryColor, accentColor],
              borderWidth: 0,
              hoverOffset: 15
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  font: { size: 13, weight: '600' },
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                padding: 12,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return ` ${context.label}: ${context.parsed} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        const statusCtx = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(statusCtx, {
          type: 'bar',
          data: {
            labels: ['Completed', 'No Show', 'Expired'],
            datasets: [{
              label: 'Tokens',
              data: [data.status.completed, data.status.no_show, data.status.expired],
              backgroundColor: [successColor, dangerColor, warningColor],
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                padding: 12,
                cornerRadius: 8
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });

        const peakCtx = document.getElementById('peakHoursChart').getContext('2d');
        if (peakHoursChart) peakHoursChart.destroy();
        peakHoursChart = new Chart(peakCtx, {
          type: 'bar',
          data: {
            labels: data.peak_hours.map(h => `${h.hour}:00 - ${h.hour + 1}:00`),
            datasets: [{
              label: 'Customers',
              data: data.peak_hours.map(h => h.count),
              backgroundColor: primaryColor,
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                padding: 12,
                cornerRadius: 8
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { precision: 0 },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              },
              y: {
                grid: { display: false }
              }
            }
          }
        });

      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    loadAnalytics();
  </script>
</body>
</html>
